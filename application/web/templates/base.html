<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>{% block title %}IV数据简易处理平台{% endblock %}</title>
  
  <!-- 网站图标 -->
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* 全局样式 */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background-color: #f5f7fa;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .container-fluid {
      padding: 0 15px;
      flex: 1;
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #eaeaea;
    }
    
    .upload-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
    }
    
    /* 图片点击效果 */
    #plot, #summaryTable, .thumb {
      transition: transform 0.2s ease;
    }
    
    #plot:hover, #summaryTable:hover, .thumb:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* 模态框图片样式 */
    #modalImage {
      max-height: 70vh;
      object-fit: contain;
    }
    
    .modal-xl {
      max-width: 90%;
    }
    
    /* 处理结果消息样式 */
    .success {
      color: #198754;
      background-color: #d1e7dd;
      border: 1px solid #badbcc;
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 10px;
    }
    
    .error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c2c7;
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 10px;
    }
    
    .process-result-container {
      min-height: 50px;
    }
    
    /* 空状态提示 */
    .empty-message {
      text-align: center;
      color: #6c757d;
      padding: 30px 15px;
      font-style: italic;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px dashed #dee2e6;
    }
    
    /* 上传区域整体样式 */
    .upload-controls-row {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    /* 控件组优化 */
    .input-group .btn {
      min-width: 40px;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
      .container-fluid {
        padding: 0 10px;
      }
      
      .main-content {
        flex-direction: column;
        height: auto !important;
      }
      
      .col-3, .col {
        width: 100% !important;
        margin-bottom: 20px;
      }
    }
    
    /* 动画效果 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 页脚样式 */
    .footer {
      border-top: 1px solid #e9ecef;
      padding: 0.75rem 0;
      background-color: #f8f9fa;
      font-size: 0.8rem;
      flex-shrink: 0; /* 页脚不收缩 */
      margin-top: auto; /* 推到底部 */
      width: 100%;
    }
    
    .footer-content {
      padding: 8px 0;
    }
    
    .footer a {
      color: #4361ee;
      transition: color 0.2s ease;
      font-size: 0.8rem;
    }
    
    .footer a:hover {
      color: #3a56d4;
      text-decoration: underline;
    }
    
    .footer .text-muted {
      color: #6c757d !important;
    }
    
    /* 模态框修复样式 */
    .modal {
      backdrop-filter: blur(2px);
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1040;
      width: 100vw;
      height: 100vh;
      background-color: #000;
      opacity: 0.5;
    }
    
    .modal-backdrop.fade {
      opacity: 0;
    }
    
    .modal-backdrop.show {
      opacity: 0.5;
    }
    
    /* 确保模态框在最上层 */
    .modal.show {
      display: block;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    /* 修复body滚动 */
    body.modal-open {
      overflow: hidden;
      padding-right: 0 !important;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
      .footer {
        font-size: 0.7rem;
        padding: 0.5rem 0;
      }
      
      .footer a {
        font-size: 0.7rem;
      }
      
      .footer .small {
        font-size: 0.7rem;
      }
      
      .footer .text-muted {
        font-size: 0.65rem;
      }
    }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>
  <div class="container-fluid">
    {% block content %}{% endblock %}
  </div>
  
  <!-- 图片放大模态框 -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">图片预览</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" src="" alt="放大预览" class="img-fluid">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" class="btn btn-primary" onclick="downloadModalImage()">下载图片</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 上传进度模态框 -->
  <div class="modal fade" id="uploadProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">上传进度</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭" onclick="cancelUpload()"></button>
        </div>
        <div class="modal-body">
          <!-- 总体进度 -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>总体进度</span>
              <span id="overallProgressText">0%</span>
            </div>
            <div class="progress" style="height: 20px;">
              <div id="overallProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- 当前文件进度 -->
          <div id="currentFileSection" style="display: none;">
            <div class="d-flex justify-content-between mb-1">
              <span>当前文件：<span id="currentFileName" class="text-truncate"></span></span>
              <span id="currentFileProgressText">0%</span>
            </div>
            <div class="progress" style="height: 15px;">
              <div id="currentFileProgressBar" class="progress-bar bg-info" 
                   role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- 上传统计 -->
          <div class="mt-3">
            <div class="row text-center">
              <div class="col-6">
                <div class="small text-muted">已上传</div>
                <div class="h5" id="uploadedCount">0</div>
              </div>
              <div class="col-6">
                <div class="small text-muted">总文件</div>
                <div class="h5" id="totalFilesCount">0</div>
              </div>
            </div>
          </div>
          
          <!-- 上传速度和时间估计 -->
          <div class="mt-3" id="speedInfo" style="display: none;">
            <div class="small text-muted">
              速度: <span id="uploadSpeed">0 KB/s</span> | 
              剩余时间: <span id="timeRemaining">计算中...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cancelUpload()">取消上传</button>
        </div>
      </div>
    </div>
  </div>

  {% block scripts %}
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JSZip库用于打包下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- 全局函数定义（供图片预览使用） -->
    <script>
      // 这些函数将在对应的模块中定义，这里提供兼容性保证
      if (typeof window.showImageInModal === 'undefined') {
        window.showImageInModal = function(imageUrl, imageTitle) {
          console.warn('showImageInModal: image-viewer模块未正确加载');
          // 简单回退实现
          const modalImage = document.getElementById('modalImage');
          const modalTitle = document.getElementById('modalTitle');
          if (modalImage && modalTitle) {
            modalImage.src = imageUrl;
            modalTitle.textContent = imageTitle;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
          }
        };
      }
      
      if (typeof window.downloadModalImage === 'undefined') {
        window.downloadModalImage = function() {
          console.warn('downloadModalImage: image-viewer模块未正确加载');
          const modalImage = document.getElementById('modalImage');
          if (modalImage && modalImage.src) {
            const imageUrl = modalImage.src.split('?')[0];
            const fileName = imageUrl.split('/').pop().split('?')[0] || 'image.png';
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        };
      }
      
      if (typeof window.hideBackendMessage === 'undefined') {
        window.hideBackendMessage = function() {
          const container = document.getElementById('backendMessageContainer');
          if (container) container.style.display = 'none';
        };
      }
      
      if (typeof window.cancelUpload === 'undefined') {
        window.cancelUpload = function() {
          console.warn('cancelUpload: upload模块未正确加载');
        };
      }
      
      // 模态框修复函数
      function fixModalBackdrop() {
        // 确保遮罩层被移除
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(function(backdrop) {
          if (backdrop.parentNode) {
            backdrop.parentNode.removeChild(backdrop);
          }
        });
        
        // 确保body样式恢复
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
      
      // 监听所有模态框的隐藏事件
      document.addEventListener('DOMContentLoaded', function() {
        const modalElements = document.querySelectorAll('.modal');
        modalElements.forEach(function(modal) {
          modal.addEventListener('hidden.bs.modal', function(event) {
            setTimeout(fixModalBackdrop, 100);
          });
          
          // 点击关闭按钮时也修复
          const closeBtn = modal.querySelector('.btn-close[data-bs-dismiss="modal"]');
          if (closeBtn) {
            closeBtn.addEventListener('click', function() {
              setTimeout(fixModalBackdrop, 100);
            });
          }
        });
      });
    </script>
    
    <!-- 应用JavaScript文件（按依赖顺序加载） -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/local-storage-manager.js"></script>
    <script src="/static/js/dataset-manager.js"></script>
    <script src="/static/js/upload.js"></script>
    <script src="/static/js/download.js"></script>
    <script src="/static/js/image-viewer.js"></script>
    <script src="/static/js/main.js"></script>
  {% endblock %}
  
  <!-- 备案信息页脚 -->
  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-8 offset-md-2 text-center">
          <div class="footer-content">
            <p class="mb-1 small">
              © 2025 IV数据简易处理平台 | 
              <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                湘ICP备2025150577号
              </a>
              <span class="mx-1">|</span>
              <img src="/static/备案图标.png" alt="公安备案图标" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 2px;">
              <a href="https://beian.mps.gov.cn/#/query/webSearch?code=43112402000158" 
                 target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                湘公网安备43112402000158号
              </a>
              <span class="mx-1">|</span>
              <a href="https://github.com/taorong99/IV_dataprocess" 
                target="_blank" rel="noopener noreferrer" 
                class="text-decoration-none"
                title="查看项目源代码">
                <svg style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 2px;" 
                    fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub
              </a>
            </p>
            <p class="small text-muted mb-0" style="font-size: 0.75rem;">
              本平台仅用于科研数据分析，上传数据请遵守相关法律法规
            </p>
          </div>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>